rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for authentication and authorization
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email != null &&
             request.auth.token.email_verified == true;
    }
    
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidArticleData(data) {
      return data.keys().hasAll(['title', 'slug', 'content', 'categoryId', 'status']) &&
             data.title is string && data.title.size() > 0 &&
             data.slug is string && data.slug.size() > 0 &&
             data.content is string && data.content.size() > 0 &&
             data.categoryId is string &&
             data.status in ['draft', 'published', 'archived'] &&
             data.tags is list &&
             data.readingTime is number &&
             data.viewCount is number;
    }
    
    function isValidCategoryData(data) {
      return data.keys().hasAll(['name', 'slug']) &&
             data.name is string && data.name.size() > 0 &&
             data.slug is string && data.slug.size() > 0;
    }
    
    function isValidTagData(data) {
      return data.keys().hasAll(['name', 'slug']) &&
             data.name is string && data.name.size() > 0 &&
             data.slug is string && data.slug.size() > 0;
    }
    
    function isValidSubscriberData(data) {
      return data.keys().hasAll(['email', 'status']) &&
             isValidEmail(data.email) &&
             data.status in ['active', 'unsubscribed'];
    }
    
    // Articles collection
    match /articles/{articleId} {
      // Public read access for published articles, admin can read all
      allow read: if resource.data.status == 'published' || isAdmin();
      
      // Admin-only write access with data validation
      allow create: if isAdmin() && 
                       isValidArticleData(request.resource.data) &&
                       request.resource.data.createdAt == request.time &&
                       request.resource.data.updatedAt == request.time;
      
      allow update: if isAdmin() && 
                       isValidArticleData(request.resource.data) &&
                       request.resource.data.createdAt == resource.data.createdAt &&
                       request.resource.data.updatedAt == request.time;
      
      allow delete: if isAdmin();
      
      // Comments subcollection
      match /comments/{commentId} {
        // Public read access for approved comments, admin can read all
        allow read: if resource.data.status == 'approved' || isAdmin();
        
        // Public create access with validation
        allow create: if isValidEmail(request.resource.data.authorEmail) &&
                         request.resource.data.content is string &&
                         request.resource.data.content.size() > 0 &&
                         request.resource.data.status == 'pending' &&
                         request.resource.data.createdAt == request.time;
        
        // Admin-only update and delete
        allow update, delete: if isAdmin();
      }
    }
    
    // Categories collection
    match /categories/{categoryId} {
      // Public read access
      allow read: if true;
      
      // Admin-only write access with validation
      allow create: if isAdmin() && 
                       isValidCategoryData(request.resource.data) &&
                       request.resource.data.createdAt == request.time;
      
      allow update: if isAdmin() && 
                       isValidCategoryData(request.resource.data) &&
                       request.resource.data.createdAt == resource.data.createdAt;
      
      allow delete: if isAdmin();
    }
    
    // Tags collection
    match /tags/{tagId} {
      // Public read access
      allow read: if true;
      
      // Admin-only write access with validation
      allow create: if isAdmin() && 
                       isValidTagData(request.resource.data) &&
                       request.resource.data.createdAt == request.time;
      
      allow update: if isAdmin() && 
                       isValidTagData(request.resource.data) &&
                       request.resource.data.createdAt == resource.data.createdAt;
      
      allow delete: if isAdmin();
    }
    
    // Subscribers collection
    match /subscribers/{subscriberId} {
      // No public read access (privacy protection)
      allow read: if isAdmin();
      
      // Public create access for newsletter subscription with validation
      allow create: if isValidSubscriberData(request.resource.data) &&
                       request.resource.data.subscribedAt == request.time;
      
      // Allow users to unsubscribe themselves by email match
      allow update: if request.resource.data.email == resource.data.email &&
                       request.resource.data.status == 'unsubscribed' &&
                       request.resource.data.subscribedAt == resource.data.subscribedAt;
      
      // Admin access for subscriber management
      allow update, delete: if isAdmin();
    }
    
    // Site configuration collection
    match /siteConfig/{configId} {
      // Public read access for theme and branding
      allow read: if configId in ['theme', 'branding', 'layout', 'seo'];
      
      // Admin-only write access
      allow create, update, delete: if isAdmin();
    }
    
    // Analytics collections
    match /pageViews/{viewId} {
      // No public read access
      allow read: if false;
      
      // Public create access for tracking page views
      allow create: if request.resource.data.timestamp == request.time &&
                       request.resource.data.page is string &&
                       request.resource.data.sessionId is string;
      
      // Admin read access for analytics
      allow read: if isAdmin();
      
      // No update or delete (immutable analytics data)
      allow update, delete: if false;
    }
    
    // Helper functions for analytics data validation
    function isValidPageViewData(data) {
      return data.keys().hasAll(['timestamp', 'page', 'sessionId']) &&
             data.timestamp is timestamp &&
             data.page is string && data.page.size() > 0 && data.page.size() <= 500 &&
             data.sessionId is string && data.sessionId.size() > 0 && data.sessionId.size() <= 100 &&
             (!data.keys().hasAny(['userAgent']) || (data.userAgent is string && data.userAgent.size() <= 1000)) &&
             (!data.keys().hasAny(['referrer']) || (data.referrer is string && data.referrer.size() <= 500));
    }
    
    function isValidRealTimeVisitorData(data) {
      return data.keys().hasAll(['sessionId']) &&
             data.sessionId is string && data.sessionId.size() > 0 && data.sessionId.size() <= 100 &&
             (!data.keys().hasAny(['timestamp']) || data.timestamp is timestamp) &&
             (!data.keys().hasAny(['pageViews']) || (data.pageViews is number && data.pageViews >= 0 && data.pageViews <= 10000)) &&
             (!data.keys().hasAny(['currentPage']) || (data.currentPage is string && data.currentPage.size() <= 500)) &&
             (!data.keys().hasAny(['userAgent']) || (data.userAgent is string && data.userAgent.size() <= 1000)) &&
             (!data.keys().hasAny(['referrer']) || (data.referrer is string && data.referrer.size() <= 500)) &&
             (!data.keys().hasAny(['userId']) || (data.userId is string && data.userId.size() <= 100));
    }
    
    function isValidDailySummaryData(data) {
      return (!data.keys().hasAny(['date']) || (data.date is string && data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$'))) &&
             (!data.keys().hasAny(['lastUpdated']) || data.lastUpdated is timestamp) &&
             (!data.keys().hasAny(['totalViews']) || (data.totalViews is number && data.totalViews >= 0 && data.totalViews <= 1000000)) &&
             (!data.keys().hasAny(['uniqueVisitors']) || (data.uniqueVisitors is number && data.uniqueVisitors >= 0 && data.uniqueVisitors <= 100000)) &&
             (!data.keys().hasAny(['topPages']) || (data.topPages is list && data.topPages.size() <= 100));
    }
    
    // Enhanced analytics collections with proper validation
    match /pageviews/{viewId} {
      allow read: if isAdmin();
      allow create: if isValidPageViewData(request.resource.data);
      allow update, delete: if false;
    }
    
    match /realTimeVisitors/{visitorId} {
      allow read: if isAdmin();
      allow create: if isValidRealTimeVisitorData(request.resource.data);
      allow update: if isValidRealTimeVisitorData(request.resource.data);
      allow delete: if isAdmin();
    }
    
    match /dailySummaries/{summaryId} {
      allow read: if isAdmin();
      allow create: if isValidDailySummaryData(request.resource.data);
      allow update: if isValidDailySummaryData(request.resource.data);
      allow delete: if isAdmin();
    }
    
    // Additional collections used by the analytics code - fully permissive for debugging
    match /analytics_daily_summary/{summaryId} {
      allow read, write: if true; // Fully permissive for debugging
    }
    
    match /analytics_sessions/{sessionId} {
      allow read, write: if true; // Fully permissive for debugging
    }
    
    match /analytics_articles/{articleId} {
      allow read, write: if true; // Fully permissive for debugging
    }
    
    // Legacy analytics collections - temporarily fully permissive for debugging
    match /analytics_pageviews/{viewId} {
      allow read, write: if true; // Fully permissive for debugging
    }
    
    match /analytics_realtime_visitors/{visitorId} {
      allow read, write: if true; // Fully permissive for debugging
    }
    
    match /analytics_article_performance/{articleId} {
      allow read: if isAdmin();
      allow create, update: if request.resource.data.keys().hasAll(['articleId', 'timestamp']) &&
                              request.resource.data.articleId is string && request.resource.data.articleId.size() > 0 &&
                              request.resource.data.timestamp is timestamp &&
                              (!request.resource.data.keys().hasAny(['views']) || (request.resource.data.views is number && request.resource.data.views >= 0)) &&
                              (!request.resource.data.keys().hasAny(['engagement']) || (request.resource.data.engagement is number && request.resource.data.engagement >= 0));
      allow delete: if false;
    }
    
    match /analytics_trending/{articleId} {
      allow read: if isAdmin();
      allow create, update: if request.resource.data.keys().hasAll(['articleId', 'timestamp']) &&
                              request.resource.data.articleId is string && request.resource.data.articleId.size() > 0 &&
                              request.resource.data.timestamp is timestamp &&
                              (!request.resource.data.keys().hasAny(['score']) || (request.resource.data.score is number && request.resource.data.score >= 0));
      allow delete: if false;
    }
    
    match /analytics_sessions/{sessionId} {
      allow read: if isAdmin();
      allow create, update: if request.resource.data.keys().hasAll(['sessionId', 'timestamp']) &&
                              request.resource.data.sessionId is string && request.resource.data.sessionId.size() > 0 &&
                              request.resource.data.timestamp is timestamp &&
                              (!request.resource.data.keys().hasAny(['duration']) || (request.resource.data.duration is number && request.resource.data.duration >= 0)) &&
                              (!request.resource.data.keys().hasAny(['pageCount']) || (request.resource.data.pageCount is number && request.resource.data.pageCount >= 0));
      allow delete: if false;
    }
    
    match /analytics_daily_summaries/{date} {
      allow read: if isAdmin();
      allow create: if isValidDailySummaryData(request.resource.data);
      allow update: if isValidDailySummaryData(request.resource.data);
      allow delete: if false;
    }
    
    // Health check collection
    match /health/{healthId} {
      allow read: if true; // Allow public read for health checks
      allow write: if false; // No writes needed
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}